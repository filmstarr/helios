<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>helios</title>
<script type="text/javascript" src="scripts\jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="scripts\jquery-ui.min.js"></script>
<script type="text/javascript" src="scripts\paper-full.min.js"></script>
<script type="text/javascript" src="scripts\suncalc.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    $("#canvas").fadeIn(1500, "easeInOutQuart");
  });

</script>
<script type="text/paperscript" canvas="canvas">

	//Debugging
	var debug = false;

  //Define parameters
  var secondsInDay = 60 * 60 * 24;
  var sunRadius = 10;
  var xBuffer = 0;
  var yBuffer = 1 + sunRadius;
	var ySize = 200;
	var xSize = ((window.innerWidth > 0) ? window.innerWidth : screen.width) - (2 * xBuffer);
  var framesPerSecond = 1;
  var lineColour = 'white';
  if (debug) {
    framesPerSecond = 600;
  }

  //Initialise some variables
  var latitude = localStorage.latitude ? localStorage.latitude : 0;
  var longitude = localStorage.longitude ? localStorage.longitude : 0;
  var sunrise;
  var sunset;
  var degreeMidday;

  if (debug) {
    console.log('Latitude: ' + latitude);
    console.log('Longitude: ' + longitude);
  }

  //Create sun's path
  var pathPoints = 360;
	var sunPath = new Path();
  sunPath.strokeColor = lineColour;

  //Create horizon
  var horizon = new Path.Line();
  horizon.strokeColor = lineColour;

  //Create sun
  var helios = new Path.Circle(-(sunRadius + 1), 0, sunRadius);
  helios.strokeColor = lineColour;
  helios.fillColor = lineColour;


  //Functions
  function altitude(fractionalTime) {
    var degreeTime = 360 * fractionalTime;
    var fractionalAltitude = (1 + Math.cos((degreeTime + 180 - degreeMidday) * Math.PI / 180)) / 2;
    return fractionalAltitude * ySize;
  }

  function fractionalTime(date) {
  	var seconds = secondsSinceStartOfDay(date);
		return seconds / secondsInDay;
  }

  function calculateDegreeMidday() {
    var midday = (secondsSinceStartOfDay(sunrise) + secondsSinceStartOfDay(sunset)) / 2;
    return 360 * midday / secondsInDay;
  }

  function secondsSinceStartOfDay(date) {
    return date.getSeconds() + (60 * date.getMinutes()) + (60 * 60 * date.getHours());
  }

  function updateLocation() {
    //Request location data
    if (debug) {
      console.log('Requesting location...');
    }

    $.ajax({ 
      url: 'http://freegeoip.net/json/', 
      type: 'POST', 
      dataType: 'jsonp',
      success: function(location) {
        if (debug) {
          console.log('Latitude: ' + location.latitude);
          console.log('Longitude: ' + location.longitude);
        }
        latitude = location.latitude;
        longitude = location.longitude;
        localStorage.latitude = latitude;
        localStorage.longitude = longitude;
        localStorage.locationAsOf = new Date();

        //Update sunrise and sunset times
        updateSunriseSunset();
      }
    });
  }

  function updateSunriseSunset() {
    if (debug) {
      console.log('Updating sunrise and sunset');
    }

    var times = SunCalc.getTimes(new Date(), latitude, longitude);
    if (debug) {
      console.log('Sunrise: ' + times.sunrise);
      console.log('Sunset: ' + times.sunset);
    }

    if (sunrise != times.sunrise || sunset != times.sunset) {
      sunrise = times.sunrise;
      sunset = times.sunset;
      degreeMidday = calculateDegreeMidday();
      sightSunPath();
      sightHorizon();
    }
  }


  //Update items
  function sightSunPath() {
    sunPath.removeSegments();
    for (var i = 0; i <= pathPoints; i++) {
      var point = new Point(xBuffer + ( xSize * i / pathPoints), yBuffer + altitude(i / pathPoints));
      sunPath.add(point);
    }
    sunPath.smooth();
    sunPath.simplify();
  }

  function sightHorizon() {
    horizon.removeSegments();
    var horizonAltitude = altitude(fractionalTime(sunrise));
    var yHorizon = yBuffer + horizonAltitude;

    var from = new Point(xBuffer, yHorizon);
    var to = new Point(xBuffer + xSize, yHorizon);

    horizon.add(from);
    horizon.add(to);
  }

  function sightSun() {
    var date = new Date();
    var timeFraction = fractionalTime(date);
    if (debug) {
      timeFraction = (date.getMilliseconds() + ((date.getSeconds() % 10) * 1000)) / (1000 * 10);
    }
    helios.position.x = xBuffer + (xSize * timeFraction);
    helios.position.y = yBuffer + altitude(timeFraction);
  }


  //Events
  var previousSunRequestTime = new Date(1970, 1, 1, 0, 0, 0, 0);
  var previousLocationRequestTime = new Date(1970, 1, 1, 0, 0, 0, 0);
  var previousSunriseSunsetRequestDate = new Date(1970, 1, 1, 0, 0, 0, 0);
  function onFrame(event) {
    var requestTime = new Date();

    //Update location once a day or if we have no data try each hour
    if ((!localStorage.locationAsOf || requestTime - localStorage.locationAsOf >= 1000 * secondsInDay)
        && requestTime - previousLocationRequestTime >= 1000 * 60 * 60) {
      updateLocation();
      previousLocationRequestTime = requestTime;
    }

    //Update sunrise and sunset when the date changes
    var date = (new Date()).setHours(0,0,0,0);
    if (date > previousSunriseSunsetRequestDate) {
      updateSunriseSunset()
      previousSunriseSunsetRequestDate = date;
    }

    //Update sun position
    if (requestTime - previousSunRequestTime >= 1000 / framesPerSecond) {
      sightSun();
      previousSunRequestTime = requestTime;
    }
  }

  helios.onClick = function(event) {
    debug = !debug;
    framesPerSecond = debug ? 600 : 1;
    sightSun();
  }

</script>
</head>

<body style="margin: 0; padding-top: 200px;">
	<canvas id="canvas" resize style="display: none;"></canvas>
</body>

</html>