<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>helios</title>
<script type="text/javascript" src="scripts\jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="scripts\jquery-ui.min.js"></script>
<script type="text/javascript" src="scripts\paper-full.min.js"></script>
<script type="text/javascript" src="scripts\suncalc.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    $("#canvas").fadeIn(1500, "easeInOutQuart");
  });

</script>
<script type="text/paperscript" canvas="canvas">


	//Debugging
	var debug = false;


  //Define plot variables
  var secondsInDay = 60 * 60 * 24;
  var sunRadius = 10;
  var xBuffer = 0;
  var yBuffer = 1 + sunRadius;
	var ySize = 200;
	var xSize = ((window.innerWidth > 0) ? window.innerWidth : screen.width) - (2 * xBuffer);
  var framesPerSecond = 1;
  var lineColour = "white";
  if (debug) {
    framesPerSecond = 600;
    lineColour = "black";
  }


  //Initialise some variables
  var sunrise = new Date(1970, 1, 1, 6, 0, 0, 0);
  var sunset = new Date(1970, 1, 1, 18, 0, 0, 0);
  var degreeMidday = 180;


  //Draw sun's path
  var pathPoints = 360;
	var sunPath = new Path();
  sunPath.strokeColor = lineColour;
  sightSunPath();

  //Draw horizon
  var from = new Point(xBuffer, 0);
  var to = new Point(xBuffer + xSize, 0);
  var horizon = new Path.Line(from, to);
  horizon.strokeColor = lineColour;
  sightHorizon();

  //Draw the sun
  var helios = new Path.Circle(0,0,sunRadius);
  helios.strokeColor = lineColour;
  helios.fillColor = lineColour;
 	sightSun();


  //Functions
  function altitude(fractionalTime) {
    var degreeTime = 360 * fractionalTime;
    var fractionalAltitude = (1 + Math.cos((degreeTime + 180 - degreeMidday) * Math.PI / 180)) / 2;
    return fractionalAltitude * ySize;
  }

  function fractionalTime(date) {
  	var seconds = secondsSinceStartOfDay(date);
		return seconds / secondsInDay;
  }

  function fractionalMidday() {
    var midday = (secondsSinceStartOfDay(sunset) + secondsSinceStartOfDay(sunrise)) / 2;
    return midday / secondsInDay;
  }

  function secondsSinceStartOfDay(date) {
    return date.getSeconds() + (60 * date.getMinutes()) + (60 * 60 * date.getHours());
  }

  function updateSunPathAndHorizon() {
    //Request location data
    if (debug) {
      console.log('Requesting location...');
    }
    $.ajax({ 
      url: 'http://freegeoip.net/json/', 
      type: 'POST', 
      dataType: 'jsonp',
      success: function(location) {
        if (debug) {
          console.log('latitude: ' + location.latitude);
          console.log('longitude: ' + location.longitude);
        }
        setSunriseSunset(location.latitude, location.longitude);

        //Replot the sun's path and the horizon
        sightSunPath();
        sightHorizon();
      }
    });
  }

  function setSunriseSunset (latitude, longitude) {
    var times = SunCalc.getTimes(new Date(), latitude, longitude);
    if (debug) {
      console.log('Sunrise: ' + times.sunrise);
      console.log('Sunset: ' + times.sunset);
    }
    sunrise = times.sunrise;
    sunset = times.sunset;
    degreeMidday = fractionalMidday() * 360;
  }


  //Update items
  function sightSunPath() {
    sunPath.removeSegments();
    for (var i = 0; i <= pathPoints; i++) {
      var point = new Point(xBuffer + ( xSize * i / pathPoints), yBuffer + altitude(i / pathPoints));
      sunPath.add(point);
    }
    sunPath.smooth();
    sunPath.simplify();
  }

  function sightHorizon() {
    var horizonAltitude = altitude(fractionalTime(sunrise));
    var yHorizon = yBuffer + horizonAltitude;
    var segments = horizon.segments;
    for (var i = 0; i < segments.length; i++) {
      var segment = segments[i];
      segment.point.y = yHorizon;
    }
  }

  function sightSun() {
    var date = new Date();
    var timeFraction = fractionalTime(date);
    if (debug) {
      timeFraction = (date.getMilliseconds() + ((date.getSeconds() % 10) * 1000)) / (1000 * 10);
    }
    helios.position.x = xBuffer + (xSize * timeFraction);
    helios.position.y = yBuffer + altitude(timeFraction);
  }


  //Animate
  var previousSunRequestTime = new Date(1970, 1, 1, 6, 0, 0, 0);
  var previousRequestTime = new Date(1970, 1, 1, 6, 0, 0, 0);
  function onFrame(event) {
    var requestTime = new Date();

    //Update sun path and horizon once every eight hours
    if (requestTime - previousRequestTime >= 1000 * 60 * 60 * 8) {
      //ToDo: Animate moving of horizon and path
      updateSunPathAndHorizon();
      previousRequestTime = requestTime;
    }

    //Update sun position
    if (requestTime - previousSunRequestTime >= 1000 / framesPerSecond) {
      sightSun();
      previousSunRequestTime = requestTime;
    }
  }

</script>
</head>

<body style="margin: 0; padding-top: 200px;">
	<canvas id="canvas" resize style="display: none;"></canvas>
</body>

</html>